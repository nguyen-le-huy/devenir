name: Docker Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Environment Files from Secrets
        run: |
          echo "ğŸ“ Creating .env files from GitHub Secrets..."
          
          # Create server/.env from secret (remove BOM and trim)
          echo "${{ secrets.SERVER_ENV_FILE }}" | sed '1s/^\xEF\xBB\xBF//' > server/.env
          
          # Verify .env file
          if [ ! -s server/.env ]; then
            echo "âŒ server/.env is empty or missing!"
            exit 1
          fi
          
          echo "âœ… server/.env created ($(wc -l < server/.env) lines)"
          
          # Create client/.env if needed (optional)
          if [ -n "${{ secrets.CLIENT_ENV_FILE }}" ]; then
            echo "${{ secrets.CLIENT_ENV_FILE }}" | sed '1s/^\xEF\xBB\xBF//' > client/.env
            echo "âœ… client/.env created"
          fi
          
          # Create admin/.env if needed (optional)
          if [ -n "${{ secrets.ADMIN_ENV_FILE }}" ]; then
            echo "${{ secrets.ADMIN_ENV_FILE }}" | sed '1s/^\xEF\xBB\xBF//' > admin/.env
            echo "âœ… admin/.env created"
          fi
          
          echo "âœ… All environment files created successfully"

      - name: Build Docker Images
        run: |
          echo "ğŸ³ Building Docker images..."
          docker compose build
          echo "âœ… Images built successfully!"

      - name: Deploy Containers
        run: |
          echo "ğŸ”„ Restarting containers..."
          docker compose up -d
          echo "âœ… Containers restarted!"

      - name: Health Check
        run: |
          echo "â³ Waiting for services to start..."
          sleep 20
          
          echo "ğŸ“Š Container Status:"
          docker compose ps
          
          # Test local endpoints
          echo ""
          echo "ğŸ§ª Testing services..."
          curl -f http://localhost:5173 > /dev/null && echo "âœ… Client OK" || echo "âš ï¸  Client not ready"
          curl -f http://localhost:5174 > /dev/null && echo "âœ… Admin OK" || echo "âš ï¸  Admin not ready"
          curl -f http://localhost:3111 > /dev/null && echo "âœ… API OK" || echo "âš ï¸  API not ready"

      - name: Reload Nginx
        run: |
          echo "ğŸ”„ Reloading Nginx..."
          sudo nginx -t && sudo nginx -s reload || echo "âš ï¸  Nginx reload skipped"
          echo "âœ… Nginx reloaded"

      - name: Cleanup
        run: |
          echo "ğŸ§¹ Cleaning up dangling images..."
          docker image prune -f
          echo "âœ… Cleanup completed!"

  notify:
    runs-on: self-hosted
    needs: deploy
    if: always()
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… DEPLOY SUCCESSFUL!"
            echo ""
            echo "ğŸŒ Public URLs:"
            echo "   Client: https://hystudio-server.tail86e288.ts.net/"
            echo "   Admin:  https://hystudio-server.tail86e288.ts.net/admin/"
            echo "   API:    https://hystudio-server.tail86e288.ts.net/api"
            echo "   N8N:    https://hystudio-server.tail86e288.ts.net/n8n/"
          else
            echo "âŒ DEPLOY FAILED!"
            echo "ğŸ“‹ Check logs: docker compose logs -f"
          fi