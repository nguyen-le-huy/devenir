name: Docker Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_ROOT: "/home/nguyenlehuy/Development/devenir"

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Sync files to Production
        run: |
          echo "üöÄ Deploying to: ${{ env.PROJECT_ROOT }}"
          
          # Create directory if not exists
          mkdir -p ${{ env.PROJECT_ROOT }}
          
          # Sync all files (exclude unnecessary files)
          rsync -av --delete \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*/dist' \
            --exclude='*/build' \
            --exclude='*.log' \
            ./ ${{ env.PROJECT_ROOT }}/
          
          echo "‚úÖ Files synced!"

      - name: Create .env files if not exist
        run: |
          cd ${{ env.PROJECT_ROOT }}
          
          # Check and create .env for server
          if [ ! -f server/.env ]; then
            echo "‚ö†Ô∏è  server/.env not found. Please create it manually!"
            exit 1
          fi
          
          # Check and create .env for client
          if [ ! -f client/.env ]; then
            echo "‚ö†Ô∏è  client/.env not found. Creating from example..."
            cp client/.env.example client/.env || echo "Warning: .env.example not found"
          fi
          
          # Check and create .env for admin
          if [ ! -f admin/.env ]; then
            echo "‚ö†Ô∏è  admin/.env not found. Creating from example..."
            cp admin/.env.example admin/.env || echo "Warning: .env.example not found"
          fi

      - name: Build and Deploy with Docker Compose
        run: |
          cd ${{ env.PROJECT_ROOT }}
          
          echo "üê≥ Building Docker images..."
          docker-compose build --no-cache
          
          echo "üîÑ Stopping old containers..."
          docker-compose down
          
          echo "üöÄ Starting new containers..."
          docker-compose up -d
          
          echo "‚úÖ Docker containers started!"

      - name: Health Check
        run: |
          cd ${{ env.PROJECT_ROOT }}
          
          echo "‚è≥ Waiting for services to be healthy..."
          sleep 30
          
          # Check server health
          docker-compose ps | grep devenir-server | grep "Up (healthy)" || echo "‚ö†Ô∏è  Server not healthy yet"
          
          # Check client health  
          docker-compose ps | grep devenir-client | grep "Up (healthy)" || echo "‚ö†Ô∏è  Client not healthy yet"
          
          # Check admin health
          docker-compose ps | grep devenir-admin | grep "Up (healthy)" || echo "‚ö†Ô∏è  Admin not healthy yet"
          
          echo "üìä Container Status:"
          docker-compose ps

      - name: Cleanup old images
        run: |
          echo "üßπ Cleaning up old Docker images..."
          docker image prune -f
          echo "‚úÖ Cleanup completed!"

  notify:
    runs-on: self-hosted
    needs: deploy
    if: always()
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ DEPLOY SUCCESSFUL!"
            echo "üåê Client: http://your-server-ip:80"
            echo "üéõÔ∏è  Admin: http://your-server-ip:81"
            echo "üîå API: http://your-server-ip:3111"
          else
            echo "‚ùå DEPLOY FAILED!"
            echo "Check logs: docker-compose logs"
          fi