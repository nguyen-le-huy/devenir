name: Devenir Deploy Backend

on:
  push:
    branches: [ main ]

# KHAI BÃO ÄÆ¯á»œNG DáºªN 1 Láº¦N Táº I ÄÃ‚Y
env:
  # ÄÆ°á»ng dáº«n gá»‘c cá»§a dá»± Ã¡n trÃªn server
  PROJECT_ROOT: "/home/nguyenlehuy/Development/devenir"
  # ÄÆ°á»ng dáº«n vÃ o folder server (backend)
  SERVER_PATH: "/home/nguyenlehuy/Development/devenir/server"

jobs:
  deploy-backend:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Sync files to Production Folder
        run: |
          echo "ğŸš€ Deploying to: ${{ env.PROJECT_ROOT }}"
          
          # Táº¡o thÆ° má»¥c náº¿u chÆ°a cÃ³
          mkdir -p ${{ env.PROJECT_ROOT }}
          
          # Copy code backend sang (loáº¡i trá»« file rÃ¡c)
          # LÆ°u Ã½: Cáº§n cÃ i rsync trÃªn linux: sudo apt install rsync
          rsync -av --exclude='node_modules' --exclude='.git' --exclude='.github' ./server/ ${{ env.SERVER_PATH }}/
          
          echo "âœ… Files synced!"

      - name: Install Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies in ${{ env.SERVER_PATH }}"
          cd ${{ env.SERVER_PATH }}
          npm ci

      - name: Restart PM2
        run: |
          echo "ğŸ”„ Restarting PM2..."
          cd ${{ env.SERVER_PATH }}
          
          # Update env vÃ  restart
          pm2 restart devenir-server --update-env || pm2 start server.js --name devenir-server
          pm2 save
          
          echo "âœ… Backend Deployed Successfully!"

  notify:
    runs-on: self-hosted
    needs: deploy-backend
    if: always()
    steps:
      - name: Status
        run: echo "${{ needs.deploy-backend.result == 'success' && 'âœ… DEPLOY OK' || 'âŒ DEPLOY FAILED' }}"