{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "fd7c4bfe-0766-4203-8dd7-3e6e6857b41c",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        3296,
        -160
      ],
      "id": "95204cb0-9ccd-48db-8e99-6e03b5bbf2da",
      "name": "Webhook",
      "webhookId": "fd7c4bfe-0766-4203-8dd7-3e6e6857b41c"
    },
    {
      "parameters": {
        "operation": "aggregate",
        "collection": "products",
        "query": "=[\n  {\n    \"$match\": {\n      \"$expr\": {\n        \"$eq\": [\"$_id\", { \"$toObjectId\": \"{{ $('Webhook').item.json.body.productId }}\" }]\n      }\n    }\n  },\n  {\n    \"$lookup\": {\n      \"from\": \"productvariants\",\n      \"let\": { \"pid\": \"$_id\" },\n      \"pipeline\": [\n        { \"$match\": { \"$expr\": { \"$eq\": [\"$product_id\", \"$$pid\"] } } },\n        { \"$sort\": { \"price\": 1 } }\n      ],\n      \"as\": \"variants\"\n    }\n  }\n]"
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.2,
      "position": [
        3504,
        -160
      ],
      "id": "4584aeeb-593c-459a-bf4f-cd5ea842063d",
      "name": "Aggregate documents",
      "credentials": {
        "mongoDb": {
          "id": "gYNdnt8ZWFTNOZiV",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// --- LOGIC GHÃ‰P BÃ€I ÄÄ‚NG Táº I ÄÃ‚Y Äá»‚ KIá»‚M SOÃT HOÃ€N TOÃ€N --- \nconst product = $('Aggregate documents').first().json; \nlet aiContent = $input.first().json.output[0].content[0].text; \n\n// 1. CLEAN AI CONTENT (XÃ³a háº¿t markdown)\naiContent = aiContent\n  .replace(/\\*\\*/g, '')\n  .replace(/__/g, '')\n  .replace(/###/g, '')\n  .replace(/^#\\s+/gm, '')\n  .replace(/`/g, '')\n  .trim();\n\n// 2. Láº¤Y GIÃ CHÃNH XÃC Tá»ª DB (KhÃ´ng dÃ¹ng AI)\nconst firstVariant = product.variants && product.variants.length > 0 ? product.variants[0] : null;\nconst priceRaw = firstVariant ? firstVariant.price : 0;\n\n// Format giÃ¡ (VND)\nconst priceFormatted = new Intl.NumberFormat('vi-VN', { \n    style: 'currency', \n    currency: 'VND'\n}).format(priceRaw);\n\n// 3. Táº O TIÃŠU Äá»€ CHUáº¨N\nconst title = product.name ? product.name.toUpperCase() : 'NEW ARRIVAL';\n\nconst webhookData = $('Webhook').first().json.body;\nconst variantId = firstVariant ? firstVariant._id : \"\";\nconst domain = \"https://www.devenir.shop\"; \nconst productLink = variantId ? `${domain}/product-detail?id=${product._id}` : `${domain}/home`;\n\n// 4. GHÃ‰P MESSAGE CUá»I CÃ™NG\n// Cáº¥u trÃºc cá»‘ Ä‘á»‹nh, AI chá»‰ Ä‘iá»n pháº§n thÃ¢n\nconst finalMessage = `âœ¨ ${title} âœ¨\n\n${aiContent}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ’Ž GiÃ¡ Æ°u Ä‘Ã£i: ${priceFormatted}\nðŸ‘‰ MUA NGAY: ${productLink}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n#Devenir #Luxury #Fashion`;\n\n// --- Xá»¬ LÃ áº¢NH ---\nlet imageUrls = [];\nif (product.images && Array.isArray(product.images)) {\n     product.images.forEach(img => {\n         if (typeof img === 'string') imageUrls.push(img);\n         else if (img.url) imageUrls.push(img.url);\n     });\n}\nif (firstVariant) {\n    if (firstVariant.mainImage) imageUrls.unshift(firstVariant.mainImage); \n    if (firstVariant.images && Array.isArray(firstVariant.images)) {\n        imageUrls.push(...firstVariant.images);\n    }\n}\nimageUrls = [...new Set(imageUrls)].filter(url => url && url.startsWith('http')).slice(0, 10);\n\nreturn imageUrls.map(url => ({\n    json: {\n        pageId: webhookData.pageId,\n        message: finalMessage, \n        imageUrl: url \n    }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3920,
        -160
      ],
      "id": "0c00ae74-faee-49a0-a6ca-48b1a6b59f78",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/905478369317354/photos",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "url",
              "value": "={{ $json.imageUrl }}"
            },
            {
              "name": "message",
              "value": "={{ $json.message }}"
            },
            {
              "name": "published",
              "value": "false"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4128,
        -160
      ],
      "id": "4b6ff988-1b66-4922-a1d7-8b9119b55e4c",
      "name": "HTTP Request",
      "credentials": {
        "httpHeaderAuth": {
          "id": "omuKcOhglT3iz5jg",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4.0-mini",
          "mode": "list",
          "cachedResultName": "GPT-4.1-MINI"
        },
        "responses": {
          "values": [
            {
              "content": "=Nhiá»‡m vá»¥: Viáº¿t 2-3 cÃ¢u mÃ´ táº£ ngáº¯n gá»n, sang trá»ng cho sáº£n pháº©m thá»i trang nÃ y. KHÃ”NG viáº¿t giÃ¡ tiá»n. KHÃ”NG viáº¿t tiÃªu Ä‘á». Chá»‰ viáº¿t pháº§n thÃ¢n bÃ i (Body copy).\n\nTÃªn SP: {{ $json.name }}\nMÃ´ táº£ gá»‘c: {{ $json.description }}\n\nYÃªu cáº§u:\n- Tiáº¿ng Viá»‡t\n- VÄƒn phong cao cáº¥p, quyáº¿n rÅ©\n- Báº¯t Ä‘áº§u báº±ng 1 emoji phÃ¹ há»£p (ðŸŒ¹, ðŸ§¥, ðŸ‘ ...)\n- KhÃ´ng dÃ¹ng Markdown (**)."
            }
          ]
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2,
      "position": [
        3648,
        -160
      ],
      "id": "0b6fbe71-b99a-40e7-9419-bc791c7c7a11",
      "name": "Message a model",
      "credentials": {
        "openAiApi": {
          "id": "UVqEw119x1GbD95g",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Gom táº¥t cáº£ ID áº£nh Ä‘Ã£ upload\nconst mediaIds = items.map(item => ({\n    media_fbid: item.json.id\n}));\n\n// Láº¥y message vÃ  pageId tá»« node Code Ä‘áº§u tiÃªn\nconst firstCodeData = $('Code in JavaScript').first().json;\n\nreturn {\n    json: {\n        pageId: firstCodeData.pageId,\n        message: firstCodeData.message,\n        attached_media: mediaIds\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4336,
        -160
      ],
      "id": "2e7937bf-4aee-426e-8650-66ff169187bc",
      "name": "Aggregate IDs"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/{{ $json.pageId }}/feed",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "message",
              "value": "={{ $json.message }}"
            },
            {
              "name": "attached_media",
              "value": "={{ JSON.stringify($json.attached_media) }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4560,
        -160
      ],
      "id": "bcfa0a81-0131-48c6-8af2-ac03dbb6d789",
      "name": "HTTP Request1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "omuKcOhglT3iz5jg",
          "name": "Header Auth account"
        }
      }
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Aggregate documents",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate documents": {
      "main": [
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Aggregate IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate IDs": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "fe2169d4b44c72baa3b147b70fc0000eeff440c5e6839cb32e590e7c1126112c"
  }
}