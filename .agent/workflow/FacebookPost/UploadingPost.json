  {
    "nodes": [
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "fd7c4bfe-0766-4203-8dd7-3e6e6857b41c",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          3296,
          -160
        ],
        "id": "95204cb0-9ccd-48db-8e99-6e03b5bbf2da",
        "name": "Webhook",
        "webhookId": "fd7c4bfe-0766-4203-8dd7-3e6e6857b41c"
      },
      {
        "parameters": {
          "operation": "aggregate",
          "collection": "products",
          "query": "=[\n  {\n    \"$match\": {\n      \"$expr\": {\n        \"$eq\": [\"$_id\", { \"$toObjectId\": \"{{ $('Webhook').item.json.body.productId }}\" }]\n      }\n    }\n  },\n  {\n    \"$lookup\": {\n      \"from\": \"productvariants\",\n      \"let\": { \"pid\": \"$_id\" },\n      \"pipeline\": [\n        { \"$match\": { \"$expr\": { \"$eq\": [\"$product_id\", \"$$pid\"] } } },\n        { \"$sort\": { \"price\": 1 } }\n      ],\n      \"as\": \"variants\"\n    }\n  }\n]"
        },
        "type": "n8n-nodes-base.mongoDb",
        "typeVersion": 1.2,
        "position": [
          3520,
          -160
        ],
        "id": "4584aeeb-593c-459a-bf4f-cd5ea842063d",
        "name": "Aggregate documents",
        "credentials": {
          "mongoDb": {
            "id": "gYNdnt8ZWFTNOZiV",
            "name": "MongoDB account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// --- HÃ€M Há»– TRá»¢ BIáº¾N Äá»”I FONT UNICODE (Giáº£ láº­p in Ä‘áº­m FB) ---\nconst toBold = (text) => {\n    const map = {\n        'A': 'ð€', 'B': 'ð', 'C': 'ð‚', 'D': 'ðƒ', 'E': 'ð„', 'F': 'ð…', 'G': 'ð†', 'H': 'ð‡', 'I': 'ðˆ', 'J': 'ð‰', 'K': 'ðŠ', 'L': 'ð‹', 'M': 'ðŒ', 'N': 'ð', 'O': 'ðŽ', 'P': 'ð', 'Q': 'ð', 'R': 'ð‘', 'S': 'ð’', 'T': 'ð“', 'U': 'ð”', 'V': 'ð•', 'W': 'ð–', 'X': 'ð—', 'Y': 'ð˜', 'Z': 'ð™',\n        'a': 'ðš', 'b': 'ð›', 'c': 'ðœ', 'd': 'ð', 'e': 'ðž', 'f': 'ðŸ', 'g': 'ð ', 'h': 'ð¡', 'i': 'ð¢', 'j': 'ð£', 'k': 'ð¤', 'l': 'ð¥', 'm': 'ð¦', 'n': 'ð§', 'o': 'ð¨', 'p': 'ð©', 'q': 'ðª', 'r': 'ð«', 's': 'ð¬', 't': 'ð­', 'u': 'ð®', 'v': 'ð¯', 'w': 'ð°', 'x': 'ð±', 'y': 'ð²', 'z': 'ð³',\n        '0': 'ðŸŽ', '1': 'ðŸ', '2': 'ðŸ', '3': 'ðŸ‘', '4': 'ðŸ’', '5': 'ðŸ“', '6': 'ðŸ”', '7': 'ðŸ•', '8': 'ðŸ–', '9': 'ðŸ—'\n    };\n    return text.split('').map(c => map[c] || c).join('');\n};\n\n// --- Xá»¬ LÃ Dá»® LIá»†U ---\nconst product = $('Aggregate documents').first().json;\nlet aiContent = $input.first().json.output[0].content[0].text;\n\n// 1. CLEAN & FORMAT CONTENT\naiContent = aiContent\n  .replace(/\\*\\*/g, '')\n  .replace(/__/g, '')\n  .replace(/^#+\\s/gm, '')\n  .replace(/`/g, '')\n  .trim();\n\n// 2. Láº¤Y GIÃ & FORMAT\nconst firstVariant = product.variants && product.variants.length > 0 ? product.variants[0] : null;\nconst priceRaw = firstVariant ? firstVariant.price : 0;\nconst priceFormatted = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(priceRaw);\n// Biáº¿n giÃ¡ thÃ nh Ä‘áº­m\nconst priceBold = priceFormatted;\n\n// 3. TIÃŠU Äá»€ & LINK\nconst rawTitle = product.name ? product.name.toUpperCase() : 'NEW COLLECTION';\nconst displayTitle = toBold(rawTitle); // In Ä‘áº­m tiÃªu Ä‘á» báº±ng Unicode\n\nconst webhookData = $('Webhook').first().json.body;\nconst variantId = firstVariant ? firstVariant._id : \"\";\nconst cleanDomain = \"https://devenir.shop\"; \n\nlet productLink;\nif (variantId) {\n    productLink = `${cleanDomain}/product-detail?variant=${variantId}`;\n} else {\n    productLink = `${cleanDomain}/product-detail?id=${product._id}`;\n}\n\n// 4. GHÃ‰P MESSAGE (STYLE Táº P CHÃ VOGUE)\n// DÃ¹ng font Serif giáº£ láº­p cho cáº£m giÃ¡c sang trá»ng\nconst finalMessage = `${displayTitle}\\n\\n${aiContent}\\n\\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\nðŸ·ï¸ GiÃ¡: ${priceBold}\\nï¿½ï¸ Mua ngay: ${productLink}\\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\n\\n#Devenir #LuxuryStyle #OOTD`;\n\n// --- Xá»¬ LÃ áº¢NH ---\nlet imageUrls = [];\nif (product.images && Array.isArray(product.images)) {\n     product.images.forEach(img => {\n         if (typeof img === 'string') imageUrls.push(img);\n         else if (img.url) imageUrls.push(img.url);\n     });\n}\nif (firstVariant) {\n    if (firstVariant.mainImage) imageUrls.unshift(firstVariant.mainImage); \n    if (firstVariant.images && Array.isArray(firstVariant.images)) {\n        imageUrls.push(...firstVariant.images);\n    }\n}\nimageUrls = [...new Set(imageUrls)].filter(url => url && url.startsWith('http')).slice(0, 10);\n\nreturn imageUrls.map(url => ({\n    json: {\n        pageId: webhookData.pageId,\n        message: finalMessage, \n        imageUrl: url \n    }\n}));"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          4096,
          -160
        ],
        "id": "0c00ae74-faee-49a0-a6ca-48b1a6b59f78",
        "name": "Code in JavaScript"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/905478369317354/photos",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendQuery": true,
          "queryParameters": {
            "parameters": [
              {
                "name": "url",
                "value": "={{ $json.imageUrl }}"
              },
              {
                "name": "message",
                "value": "={{ $json.message }}"
              },
              {
                "name": "published",
                "value": "false"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          4320,
          -160
        ],
        "id": "4b6ff988-1b66-4922-a1d7-8b9119b55e4c",
        "name": "HTTP Request",
        "credentials": {
          "httpHeaderAuth": {
            "id": "omuKcOhglT3iz5jg",
            "name": "Header Auth account"
          }
        }
      },
      {
        "parameters": {
          "modelId": {
            "__rl": true,
            "value": "gpt-4.0-mini",
            "mode": "list",
            "cachedResultName": "GPT-4.1-MINI"
          },
          "responses": {
            "values": [
              {
                "content": "=Nhiá»‡m vá»¥: Viáº¿t Ä‘oáº¡n mÃ´ táº£ sáº£n pháº©m (Body Copy) theo phong cÃ¡ch táº¡p chÃ­ thá»i trang (Vogue/Elle).\n\nTÃªn SP: {{ $json.name }}\nMÃ´ táº£ gá»‘c: {{ $json.description }}\n\nYÃªu cáº§u:\n1. NgÃ´n ngá»¯: Tiáº¿ng Viá»‡t, vÄƒn phong sang trá»ng, bay bá»•ng, khÆ¡i gá»£i cáº£m xÃºc.\n2. Cáº¥u trÃºc: \n   - CÃ¢u má»Ÿ Ä‘áº§u (Hook): Thu hÃºt ngay láº­p tá»©c.\n   - ThÃ¢n bÃ i: MÃ´ táº£ tinh táº¿ vá» cháº¥t liá»‡u, Ä‘Æ°á»ng cáº¯t may hoáº·c cáº£m giÃ¡c khi máº·c.\n   - Káº¿t thÃºc (Call to Action nháº¹ nhÃ ng).\n3. Emoji: DÃ¹ng tá»‘i giáº£n (chá»‰ 1-2 cÃ¡i), Ä‘áº·t tinh táº¿, khÃ´ng spam.\n4. KHÃ”NG dÃ¹ng Markdown (*, #). Viáº¿t text thÆ°á»ng.\n5. Äá»™ dÃ i: 3-4 cÃ¢u cháº¯t lá»c."
              }
            ]
          },
          "builtInTools": {},
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.openAi",
        "typeVersion": 2,
        "position": [
          3744,
          -160
        ],
        "id": "0b6fbe71-b99a-40e7-9419-bc791c7c7a11",
        "name": "Message a model",
        "credentials": {
          "openAiApi": {
            "id": "UVqEw119x1GbD95g",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Gom táº¥t cáº£ ID áº£nh Ä‘Ã£ upload\nconst mediaIds = items.map(item => ({\n    media_fbid: item.json.id\n}));\n\n// Láº¥y message vÃ  pageId tá»« node Code Ä‘áº§u tiÃªn\nconst firstCodeData = $('Code in JavaScript').first().json;\n\nreturn {\n    json: {\n        pageId: firstCodeData.pageId,\n        message: firstCodeData.message,\n        attached_media: mediaIds\n    }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          4544,
          -160
        ],
        "id": "2e7937bf-4aee-426e-8650-66ff169187bc",
        "name": "Aggregate IDs"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://graph.facebook.com/{{ $json.pageId }}/feed",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendQuery": true,
          "queryParameters": {
            "parameters": [
              {
                "name": "message",
                "value": "={{ $json.message }}"
              },
              {
                "name": "attached_media",
                "value": "={{ JSON.stringify($json.attached_media) }}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          4768,
          -160
        ],
        "id": "bcfa0a81-0131-48c6-8af2-ac03dbb6d789",
        "name": "HTTP Request1",
        "credentials": {
          "httpHeaderAuth": {
            "id": "omuKcOhglT3iz5jg",
            "name": "Header Auth account"
          }
        }
      }
    ],
    "connections": {
      "Webhook": {
        "main": [
          [
            {
              "node": "Aggregate documents",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Aggregate documents": {
        "main": [
          [
            {
              "node": "Message a model",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Code in JavaScript": {
        "main": [
          [
            {
              "node": "HTTP Request",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "HTTP Request": {
        "main": [
          [
            {
              "node": "Aggregate IDs",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Message a model": {
        "main": [
          [
            {
              "node": "Code in JavaScript",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Aggregate IDs": {
        "main": [
          [
            {
              "node": "HTTP Request1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "pinData": {},
    "meta": {
      "templateCredsSetupCompleted": true,
      "instanceId": "fe2169d4b44c72baa3b147b70fc0000eeff440c5e6839cb32e590e7c1126112c"
    }
  }