{
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 12
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -384,
        -272
      ],
      "id": "98166dca-020f-48d7-9db9-a0113edb41d9",
      "name": "Schedule Hourly Check"
    },
    {
      "parameters": {
        "updates": [
          "message",
          "callback_query"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -384,
        112
      ],
      "id": "999a495b-4955-4e23-b090-f94def92ba3e",
      "name": "Telegram Trigger",
      "webhookId": "a36e7857-a7bd-42d1-acee-991f572d0cbf",
      "credentials": {
        "telegramApi": {
          "id": "GMLL1UVQZpm1qh5k",
          "name": "Devenir"
        }
      }
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.callback_query ? 'button' : ($json.message.text && $json.message.text.startsWith('/inventory') ? 'command' : 'other') }}",
        "rules": {
          "rules": [
            {
              "value2": "button"
            },
            {
              "value2": "command",
              "output": 1
            }
          ]
        }
      },
      "id": "75ebae20-a1ac-4e91-bd46-289dde92eb09",
      "name": "Main Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        -80,
        112
      ]
    },
    {
      "parameters": {
        "operation": "aggregate",
        "collection": "productvariants",
        "query": "=[\n  {\n    \"$lookup\": {\n      \"from\": \"products\",\n      \"localField\": \"product_id\",\n      \"foreignField\": \"_id\",\n      \"as\": \"product\"\n    }\n  },\n  {\n    \"$unwind\": {\n      \"path\": \"$product\",\n      \"preserveNullAndEmptyArrays\": true\n    }\n  },\n  {\n    \"$project\": {\n      \"_id\": 1,\n      \"product_id\": 1,\n      \"sku\": 1,\n      \"color\": 1,\n      \"size\": 1,\n      \"quantity\": 1,\n      \"price\": 1,\n      \"reserved\": 1,\n      \"incoming\": 1,\n      \"lowStockThreshold\": 1,\n      \"binLocation\": 1,\n      \"isActive\": 1,\n      \"updatedAt\": 1,\n      \"productName\": {\n        \"$ifNull\": [\"$product.name\", \"Unknown Product\"]\n      },\n      \"variantName\": {\n        \"$concat\": [\n          { \"$ifNull\": [\"$color\", \"No Color\"] },\n          \" - \",\n          { \"$ifNull\": [\"$size\", \"No Size\"] }\n        ]\n      },\n      \"available\": {\n        \"$subtract\": [\n          { \"$ifNull\": [\"$quantity\", 0] },\n          { \"$ifNull\": [\"$reserved\", 0] }\n        ]\n      },\n      \"status\": {\n        \"$cond\": [\n          { \"$eq\": [\"$quantity\", 0] },\n          \"out_of_stock\",\n          {\n            \"$cond\": [\n              { \"$lte\": [\"$quantity\", 10] },\n              \"low_stock\",\n              \"in_stock\"\n            ]\n          }\n        ]\n      }\n    }\n  },\n  {\n    \"$match\": {\n      \"isActive\": true,\n      \"quantity\": { \"$lte\": 10 }\n    }\n  },\n  {\n    \"$sort\": {\n      \"quantity\": 1\n    }\n  }\n]"
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.2,
      "position": [
        224,
        -112
      ],
      "id": "1db49f47-e9fb-407a-9374-34d65d379658",
      "name": "MongoDB Get Inventory",
      "alwaysOutputData": false,
      "credentials": {
        "mongoDb": {
          "id": "gYNdnt8ZWFTNOZiV",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nif (!items || items.length === 0) {\n  return {\n    json: {\n      error: true,\n      message: 'Kh√¥ng c√≥ d·ªØ li·ªáu t·ªìn kho',\n      stats: {\n        total: 0,\n        in_stock_count: 0,\n        low_stock_count: 0,\n        out_of_stock_count: 0,\n        critical_products: [],\n        total_critical: 0\n      },\n      categorized: {\n        all: [],\n        in_stock: [],\n        low_stock: [],\n        out_of_stock: []\n      },\n      timestamp: new Date().toISOString()\n    }\n  };\n}\n\nconst categorized = {\n  all: items,\n  in_stock: items.filter(item => item.json.quantity > 10),\n  low_stock: items.filter(item => item.json.quantity > 0 && item.json.quantity <= 10),\n  out_of_stock: items.filter(item => item.json.quantity === 0)\n};\n\ncategorized.low_stock.sort((a, b) => a.json.quantity - b.json.quantity);\ncategorized.out_of_stock.sort((a, b) => a.json.quantity - b.json.quantity);\n\nconst criticalItems = [...categorized.out_of_stock, ...categorized.low_stock];\n\n// CH·ªà L·∫§Y 5 S·∫¢N PH·∫®M\nconst critical_products = criticalItems.slice(0, 5).map(item => ({\n  name: `${item.json.productName} (${item.json.variantName})`,\n  quantity: item.json.quantity,\n  sku: item.json.sku || 'N/A',\n  available: item.json.available || item.json.quantity\n}));\n\nconst stats = {\n  total: parseInt(items.length),\n  in_stock_count: parseInt(categorized.in_stock.length),\n  low_stock_count: parseInt(categorized.low_stock.length),\n  out_of_stock_count: parseInt(categorized.out_of_stock.length),\n  critical_products: critical_products,\n  total_critical: criticalItems.length\n};\n\nstats.in_stock_percent = ((stats.in_stock_count / stats.total) * 100).toFixed(1);\nstats.low_stock_percent = ((stats.low_stock_count / stats.total) * 100).toFixed(1);\nstats.out_of_stock_percent = ((stats.out_of_stock_count / stats.total) * 100).toFixed(1);\n\nreturn {\n  json: {\n    stats,\n    categorized,\n    timestamp: new Date().toISOString()\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        448,
        -112
      ],
      "id": "42e8ce12-2715-465e-a21f-2614102e3006",
      "name": "Process Data"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3b4c7ed0-1f7f-4184-b04e-9f103cb2e0f4",
              "leftValue": "={{ $json.stats.low_stock_count }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        656,
        -112
      ],
      "id": "5268533b-f5d1-4674-9bf5-29c1b6cd9237",
      "name": "IF Auto Alert?"
    },
    {
      "parameters": {
        "chatId": "-1003626332168",
        "text": "=üö® *C·∫¢NH B√ÅO T·ªíN KHO DEVENIR*\n\nüìä *Th·ªëng k√™:*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚Ä¢ üì¶ T·ªïng: {{ $json.stats.total }} sp\n‚Ä¢ ‚úÖ C√≤n h√†ng: {{ $json.stats.in_stock_count }} sp ({{ $json.stats.in_stock_percent }}%)\n‚Ä¢ ‚ö†Ô∏è *S·∫Øp h·∫øt: {{ $json.stats.low_stock_count }} sp* ({{ $json.stats.low_stock_percent }}%)\n‚Ä¢ ‚ùå H·∫øt h√†ng: {{ $json.stats.out_of_stock_count }} sp ({{ $json.stats.out_of_stock_percent }}%)\n\n‚ö†Ô∏è *Top 5/{{ $json.stats.total_critical }} s·∫£n ph·∫©m c·∫ßn nh·∫≠p g·∫•p nh·∫•t:*\n{{ $json.stats.critical_products.map((p, i) => `${i+1}. ${p.name}\\n   ‚Ä¢ SKU: \\`${p.sku}\\` | C√≤n: *${p.quantity}* | Kh·∫£ d·ª•ng: ${p.available}`).join('\\n\\n') }}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüïê {{ new Date().toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' }) }}\n\nüì• *Nh·∫•n n√∫t ƒë·ªÉ t·∫£i b√°o c√°o chi ti·∫øt:*",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "üìä T·∫•t c·∫£ s·∫£n ph·∫©m",
                    "additionalFields": {
                      "callback_data": "report_all"
                    }
                  },
                  {
                    "text": "‚ö†Ô∏è S·∫Øp h·∫øt",
                    "additionalFields": {
                      "callback_data": "report_low_stock"
                    }
                  },
                  {
                    "text": "‚ùå H·∫øt h√†ng",
                    "additionalFields": {
                      "callback_data": "report_out_of_stock"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        880,
        -112
      ],
      "id": "4373bcb1-5877-41a3-8891-85c044e66a24",
      "name": "Send Alert",
      "webhookId": "c910969c-2e19-4b4a-b7a9-30735934dcbf",
      "credentials": {
        "telegramApi": {
          "id": "GMLL1UVQZpm1qh5k",
          "name": "Devenir"
        }
      }
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.callback_query.data }}",
        "rules": {
          "rules": [
            {
              "value2": "report_all"
            },
            {
              "value2": "report_low_stock",
              "output": 1
            },
            {
              "value2": "report_out_of_stock",
              "output": 2
            }
          ]
        }
      },
      "id": "70f09dbd-3649-4adf-9aac-ea53eb73e418",
      "name": "Check Button Action",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        224,
        304
      ]
    },
    {
      "parameters": {
        "jsCode": "let matchStage = {};\nlet filename = 'Ton_Kho_Devenir_';\n\n// L·∫•y d·ªØ li·ªáu an to√†n\nconst data = $input.item.json;\nconst action = data.callback_query ? data.callback_query.data : '';\n\n// QUAN TR·ªåNG: L·∫•y ID t·ª´ node g·ªëc ƒë·ªÉ kh√¥ng b·ªã m·∫•t khi qua nhi·ªÅu b∆∞·ªõc\nconst chatId = $('Telegram Trigger').item.json.callback_query.message.chat.id;\nconst callbackQueryId = $('Telegram Trigger').item.json.callback_query.id;\n\n// Logic l·ªçc d·ª±a tr√™n n√∫t b·∫•m\nif (action === 'report_all') {\n    matchStage = { \"isActive\": true };\n    filename += 'Tat_Ca';\n} \nelse if (action === 'report_low_stock') {\n    matchStage = { \n        \"isActive\": true, \n        \"quantity\": { \"$gt\": 0, \"$lte\": 10 } \n    };\n    filename += 'Sap_Het';\n} \nelse if (action === 'report_out_of_stock') {\n    matchStage = { \n        \"isActive\": true, \n        \"quantity\": 0 \n    };\n    filename += 'Het_Hang';\n}\n\nreturn {\n    json: {\n        matchStage,\n        filename: `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`,\n        chatId,\n        callbackQueryId\n    }\n};"
      },
      "id": "92fe7219-6e7f-418b-af99-c355ab9a2cd6",
      "name": "Prepare Filter",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        448,
        304
      ]
    },
    {
      "parameters": {
        "operation": "aggregate",
        "collection": "productvariants",
        "query": "=[\n  {\n    \"$lookup\": {\n      \"from\": \"products\",\n      \"localField\": \"product_id\",\n      \"foreignField\": \"_id\",\n      \"as\": \"product\"\n    }\n  },\n  {\n    \"$unwind\": {\n      \"path\": \"$product\",\n      \"preserveNullAndEmptyArrays\": true\n    }\n  },\n  {\n    \"$match\": {{ JSON.stringify($json.matchStage) }}\n  },\n  {\n    \"$project\": {\n      \"_id\": 0,\n      \"SKU\": \"$sku\",\n      \"T√™n S·∫£n Ph·∫©m\": { \"$ifNull\": [\"$product.name\", \"Unknown\"] },\n      \"Ph√¢n Lo·∫°i\": {\n          \"$concat\": [\n            { \"$ifNull\": [\"$color\", \"-\"] },\n            \" / \",\n            { \"$ifNull\": [\"$size\", \"-\"] }\n          ]\n      },\n      \"M√†u\": \"$color\",\n      \"Size\": \"$size\",\n      \"Gi√° B√°n\": \"$price\",\n      \"T·ªìn Kho\": \"$quantity\",\n      \"ƒêang Gi·ªØ (Reserved)\": { \"$ifNull\": [\"$reserved\", 0] },\n      \"Kh·∫£ D·ª•ng\": {\n        \"$subtract\": [\n          { \"$ifNull\": [\"$quantity\", 0] },\n          { \"$ifNull\": [\"$reserved\", 0] }\n        ]\n      },\n      \"V·ªã Tr√≠\": { \"$ifNull\": [\"$binLocation\", \"\"] },\n      \"Tr·∫°ng Th√°i\": {\n        \"$cond\": [\n          { \"$eq\": [\"$quantity\", 0] },\n          \"H·∫øt h√†ng\",\n          \"C√≤n h√†ng\"\n        ]\n      }\n    }\n  },\n  {\n    \"$sort\": {\n      \"quantity\": 1\n    }\n  }\n]"
      },
      "id": "d9535f8d-b8fe-4a6a-ac7e-3a2d960cf637",
      "name": "Get Report Data",
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1,
      "position": [
        656,
        304
      ],
      "credentials": {
        "mongoDb": {
          "id": "gYNdnt8ZWFTNOZiV",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "operation": "toFile",
        "fileFormat": "xlsx",
        "options": {
          "fileName": "={{ $('Prepare Filter').first().json.filename }}",
          "sheetName": "Ton Kho"
        }
      },
      "id": "71004820-7bc1-46a6-8690-46dc9cfa7b00",
      "name": "Create Excel File",
      "type": "n8n-nodes-base.spreadsheetFile",
      "typeVersion": 1,
      "position": [
        880,
        304
      ]
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "=-1003626332168",
        "binaryData": true,
        "additionalFields": {
          "caption": "üìä ƒê√¢y l√† b√°o c√°o t·ªìn kho b·∫°n y√™u c·∫ßu.",
          "parse_mode": "Markdown"
        }
      },
      "id": "ef9e966e-6a80-48d7-ba4b-1ba68a73a1a3",
      "name": "Send Excel to Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1104,
        192
      ],
      "webhookId": "ff0a064b-b472-461e-aaa8-50d8c3a8fe00",
      "credentials": {
        "telegramApi": {
          "id": "GMLL1UVQZpm1qh5k",
          "name": "Devenir"
        }
      }
    },
    {
      "parameters": {
        "operation": "answerCallbackQuery"
      },
      "id": "6b4dbfaf-88c5-479f-a82b-171aa91ff904",
      "name": "Stop Loading",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1104,
        400
      ],
      "webhookId": "80c303cf-79b5-4447-bde7-3b90efdfb46f",
      "credentials": {
        "telegramApi": {
          "id": "GMLL1UVQZpm1qh5k",
          "name": "Devenir"
        }
      }
    }
  ],
  "connections": {
    "Schedule Hourly Check": {
      "main": [
        [
          {
            "node": "MongoDB Get Inventory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Main Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Main Router": {
      "main": [
        [
          {
            "node": "Check Button Action",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "MongoDB Get Inventory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MongoDB Get Inventory": {
      "main": [
        [
          {
            "node": "Process Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Data": {
      "main": [
        [
          {
            "node": "IF Auto Alert?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Auto Alert?": {
      "main": [
        [
          {
            "node": "Send Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Button Action": {
      "main": [
        [
          {
            "node": "Prepare Filter",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Filter",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Filter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Filter": {
      "main": [
        [
          {
            "node": "Get Report Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Report Data": {
      "main": [
        [
          {
            "node": "Create Excel File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Excel File": {
      "main": [
        [
          {
            "node": "Send Excel to Telegram",
            "type": "main",
            "index": 0
          },
          {
            "node": "Stop Loading",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {
    "Telegram Trigger": [
      {
        "update_id": 100774792,
        "callback_query": {
          "id": "4141469731214187802",
          "from": {
            "id": 5259228359,
            "is_bot": false,
            "first_name": "huy",
            "username": "lehyyy",
            "language_code": "en"
          },
          "message": {
            "message_id": 69,
            "from": {
              "id": 8500376532,
              "is_bot": true,
              "first_name": "Devi",
              "username": "devenirr_bot"
            },
            "chat": {
              "id": -1003626332168,
              "title": "Devenir",
              "type": "supergroup"
            },
            "date": 1765724053,
            "text": "üö® C·∫¢NH B√ÅO T·ªíN KHO DEVENIR\n\nüìä Th·ªëng k√™:\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚Ä¢ üì¶ T·ªïng: 21 sp\n‚Ä¢ ‚úÖ C√≤n h√†ng: 0 sp (0.0%)\n‚Ä¢ ‚ö†Ô∏è S·∫Øp h·∫øt: 20 sp (95.2%)\n‚Ä¢ ‚ùå H·∫øt h√†ng: 1 sp (4.8%)\n\n‚ö†Ô∏è Top 5/21 s·∫£n ph·∫©m c·∫ßn nh·∫≠p g·∫•p nh·∫•t:\n1. Heraldic Knight Wool Sweater (Night black - XL)\n   ‚Ä¢ SKU: HER-XL-NIGHT-BLACK | C√≤n: 0 | Kh·∫£ d·ª•ng: 0\n\n2. EKD Wool Cashmere Sweater (Wine red - Free Size)\n   ‚Ä¢ SKU: EKD-FREE-SIZE-WINE-RED | C√≤n: 1 | Kh·∫£ d·ª•ng: 1\n\n3. Reversible Cashmere Scarf (Mist / Sugar - Free Size)\n   ‚Ä¢ SKU: REV-FREE SIZE-MIST-/-SUGAR | C√≤n: 2 | Kh·∫£ d·ª•ng: 2\n\n4. Detachable Scarf Wool Blend Jacket (Truffle brown - Free Size)\n   ‚Ä¢ SKU: DET-FREE-SIZE-TRUFFLE-BROWN | C√≤n: 3 | Kh·∫£ d·ª•ng: 3\n\n5. Boston Holdall (Charcoal - Free Size)\n   ‚Ä¢ SKU: BOS-FREE-SIZE-CHARCOAL | C√≤n: 3 | Kh·∫£ d·ª•ng: 3\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüïê 21:54:13 14/12/2025\n\nüì• Nh·∫•n n√∫t ƒë·ªÉ t·∫£i b√°o c√°o chi ti·∫øt:",
            "entities": [
              {
                "offset": 3,
                "length": 24,
                "type": "bold"
              },
              {
                "offset": 32,
                "length": 9,
                "type": "bold"
              },
              {
                "offset": 107,
                "length": 14,
                "type": "bold"
              },
              {
                "offset": 160,
                "length": 36,
                "type": "bold"
              },
              {
                "offset": 258,
                "length": 18,
                "type": "code"
              },
              {
                "offset": 284,
                "length": 1,
                "type": "bold"
              },
              {
                "offset": 363,
                "length": 22,
                "type": "code"
              },
              {
                "offset": 393,
                "length": 1,
                "type": "bold"
              },
              {
                "offset": 476,
                "length": 26,
                "type": "code"
              },
              {
                "offset": 510,
                "length": 1,
                "type": "bold"
              },
              {
                "offset": 603,
                "length": 27,
                "type": "code"
              },
              {
                "offset": 638,
                "length": 1,
                "type": "bold"
              },
              {
                "offset": 706,
                "length": 22,
                "type": "code"
              },
              {
                "offset": 736,
                "length": 1,
                "type": "bold"
              },
              {
                "offset": 797,
                "length": 33,
                "type": "bold"
              }
            ],
            "reply_markup": {
              "inline_keyboard": [
                [
                  {
                    "text": "üìä T·∫•t c·∫£ s·∫£n ph·∫©m",
                    "callback_data": "report_all"
                  },
                  {
                    "text": "‚ö†Ô∏è S·∫Øp h·∫øt",
                    "callback_data": "report_low_stock"
                  },
                  {
                    "text": "‚ùå H·∫øt h√†ng",
                    "callback_data": "report_out_of_stock"
                  }
                ]
              ]
            }
          },
          "chat_instance": "5792434213368843811",
          "data": "report_low_stock"
        }
      }
    ]
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "fe2169d4b44c72baa3b147b70fc0000eeff440c5e6839cb32e590e7c1126112c"
  }
}